name: MobSF Static Scan (Android)

on:
  push:
    paths:
      - "app/**/*.apk"

jobs:
  mobsf_scan:
    runs-on: ubuntu-latest

    steps:
    # -------------------------------------------------
    # 1. Checkout repository
    # -------------------------------------------------
    - name: Checkout code
      uses: actions/checkout@v4

    # -------------------------------------------------
    # 2. Install required tools
    # jq is needed to parse JSON
    # -------------------------------------------------
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y jq curl

    # -------------------------------------------------
    # 3. Verify APK exists
    # -------------------------------------------------
    - name: Verify APK file
      run: |
        ls -l app/
        test -f app/DivaApplication.apk

    # -------------------------------------------------
    # 4. Upload APK to MobSF
    # -------------------------------------------------
    - name: Upload APK to MobSF
      env:
        MOBSF_URL: ${{ secrets.MOBSF_URL }}
        MOBSF_API_KEY: ${{ secrets.MOBSF_API_KEY }}
      run: |
        echo "Uploading APK to MobSF..."

        curl -X POST "$MOBSF_URL/api/v1/upload" \
          -H "Authorization: $MOBSF_API_KEY" \
          -F "file=@app/DivaApplication.apk" \
          -o upload.json

        echo "Upload response:"
        cat upload.json

        HASH=$(jq -r '.hash' upload.json)
        echo "HASH=$HASH" >> $GITHUB_ENV

    # -------------------------------------------------
    # 5. Trigger Static Scan
    # -------------------------------------------------
    - name: Start MobSF Scan
      env:
        MOBSF_URL: ${{ secrets.MOBSF_URL }}
        MOBSF_API_KEY: ${{ secrets.MOBSF_API_KEY }}
        HASH: ${{ env.HASH }}
      run: |
        echo "Starting scan for hash: $HASH"

        curl -X POST "$MOBSF_URL/api/v1/scan" \
          -H "Authorization: $MOBSF_API_KEY" \
          -H "Content-Type: application/json" \
          -d "{\"hash\":\"$HASH\"}"

    # -------------------------------------------------
    # 6. Download JSON Report
    # -------------------------------------------------
    - name: Download MobSF Report
      env:
        MOBSF_URL: ${{ secrets.MOBSF_URL }}
        MOBSF_API_KEY: ${{ secrets.MOBSF_API_KEY }}
        HASH: ${{ env.HASH }}
      run: |
        mkdir -p app/security/reports

        curl -X POST "$MOBSF_URL/api/v1/report_json" \
          -H "Authorization: $MOBSF_API_KEY" \
          -H "Content-Type: application/json" \
          -d "{\"hash\":\"$HASH\"}" \
          -o app/security/reports/mobsf-report.json

        echo "Report saved to app/security/reports/mobsf-report.json"

    # -------------------------------------------------
    # 7. Fail build if Critical issues found
    # -------------------------------------------------
    - name: Enforce Security Gate (Critical Findings)
      run: |
        CRITICAL=$(jq '.issues | to_entries[] | select(.value.severity=="Critical")' \
          app/security/reports/mobsf-report.json | wc -l)

        echo "Critical findings count: $CRITICAL"

        if [ "$CRITICAL" -gt 0 ]; then
          echo "❌ Build failed due to Critical vulnerabilities"
          exit 1
        else
          echo "✅ No Critical vulnerabilities found"
        fi
